<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ“œ æè¯å™¨ - è‡ªåª’ä½“åšä¸»å¿…å¤‡</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', sans-serif;
            background: #000;
            color: #fff;
            min-height: 100vh;
            overflow: hidden;
        }
        
        /* è®¾ç½®é¢æ¿ */
        .settings-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            z-index: 100;
            padding: 20px;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }
        
        .settings-panel.hidden {
            transform: translateY(100%);
        }
        
        .settings-panel h1 {
            text-align: center;
            font-size: 28px;
            margin-bottom: 20px;
            color: #ff6b9d;
        }
        
        .settings-panel h1 span {
            font-size: 32px;
        }
        
        textarea {
            width: 100%;
            height: 200px;
            padding: 15px;
            font-size: 18px;
            border: 2px solid #ff6b9d;
            border-radius: 12px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            resize: vertical;
            margin-bottom: 20px;
        }
        
        textarea::placeholder {
            color: rgba(255,255,255,0.5);
        }
        
        .control-group {
            margin-bottom: 20px;
        }
        
        .control-group label {
            display: block;
            font-size: 16px;
            margin-bottom: 8px;
            color: #ff6b9d;
        }
        
        .control-group input[type="range"] {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            background: rgba(255,107,157,0.3);
            border-radius: 4px;
            outline: none;
        }
        
        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: #ff6b9d;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .value-display {
            text-align: center;
            font-size: 14px;
            color: rgba(255,255,255,0.7);
            margin-top: 5px;
        }
        
        .toggle-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .toggle-btn {
            flex: 1;
            min-width: 100px;
            padding: 12px 20px;
            border: 2px solid #ff6b9d;
            background: transparent;
            color: #fff;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .toggle-btn.active {
            background: #ff6b9d;
        }
        
        .toggle-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .start-btn {
            width: 100%;
            padding: 18px;
            font-size: 22px;
            font-weight: bold;
            background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%);
            border: none;
            border-radius: 30px;
            color: #fff;
            cursor: pointer;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(255,107,157,0.4);
        }
        
        .feature-note {
            font-size: 12px;
            color: rgba(255,255,255,0.5);
            margin-top: 5px;
        }
        
        /* æè¯å™¨ç•Œé¢ */
        .teleprompter {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
            flex-direction: column;
            background: #000;
        }
        
        .teleprompter.active {
            display: flex;
        }
        
        .prompter-text {
            flex: 1;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .text-content {
            text-align: center;
            line-height: 1.8;
            transition: transform 0.15s ease-out;
        }
        
        .text-content.mirrored {
            transform: scaleX(-1);
        }
        
        .text-content p {
            margin: 0.5em 0;
            transition: all 0.3s;
        }
        
        .text-content p.current {
            color: #ff6b9d;
            text-shadow: 0 0 20px rgba(255,107,157,0.5);
        }
        
        .text-content p.spoken {
            opacity: 0.4;
        }
        
        /* ä¸­å¿ƒæŒ‡ç¤ºçº¿ */
        .center-line {
            position: fixed;
            left: 0;
            right: 0;
            top: 50%;
            height: 3px;
            background: rgba(255,107,157,0.5);
            pointer-events: none;
            z-index: 10;
        }
        
        /* æ¸å˜é®ç½© */
        .fade-top, .fade-bottom {
            position: fixed;
            left: 0;
            right: 0;
            height: 100px;
            pointer-events: none;
            z-index: 5;
        }
        
        .fade-top {
            top: 0;
            background: linear-gradient(to bottom, #000 0%, transparent 100%);
        }
        
        .fade-bottom {
            bottom: 60px;
            background: linear-gradient(to top, #000 0%, transparent 100%);
        }
        
        /* è¯­éŸ³çŠ¶æ€æŒ‡ç¤º */
        .voice-indicator {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            padding: 12px 20px;
            background: rgba(76, 175, 80, 0.95);
            border-radius: 12px;
            font-size: 16px;
            z-index: 30;
            display: none;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .voice-indicator.active {
            display: flex;
        }
        
        .voice-indicator .mic-icon {
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .voice-indicator .heard-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 14px;
        }
        
        /* æ§åˆ¶æ  */
        .control-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding: 0 10px;
            z-index: 20;
        }
        
        .ctrl-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .ctrl-btn.play {
            width: 60px;
            height: 60px;
            background: #ff6b9d;
            font-size: 28px;
        }
        
        .ctrl-btn.voice-active {
            background: #4CAF50;
            animation: pulse 1s infinite;
        }
        
        .speed-adjust {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #fff;
            font-size: 14px;
        }
        
        .speed-adjust button {
            width: 36px;
            height: 36px;
            border: 2px solid #ff6b9d;
            background: transparent;
            color: #fff;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
        }
        
        /* å€’è®¡æ—¶ */
        .countdown {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 120px;
            font-weight: bold;
            color: #ff6b9d;
            z-index: 200;
        }
        
        .countdown.active {
            display: flex;
        }
    </style>
</head>
<body>
    <!-- è®¾ç½®é¢æ¿ -->
    <div class="settings-panel" id="settingsPanel">
        <h1><span>ğŸ“œ</span> æè¯å™¨</h1>
        
        <div style="position: relative;">
            <textarea id="scriptText" placeholder="åœ¨è¿™é‡Œç²˜è´´ä½ çš„æ–‡æ¡ˆ...&#10;&#10;æ”¯æŒå¤šæ®µè½ï¼Œæ»šåŠ¨æ’­æ”¾æ—¶ä¼šè‡ªåŠ¨å±…ä¸­æ˜¾ç¤ºã€‚">å¤§å®¶å¥½ï¼Œæ¬¢è¿æ¥åˆ°æˆ‘çš„å°çº¢ä¹¦ï¼

ä»Šå¤©æƒ³å’Œå¤§å®¶åˆ†äº«ä¸€ä¸ªè¶…çº§å®ç”¨çš„æŠ€å·§ã€‚

å¾ˆå¤šå°ä¼™ä¼´é—®æˆ‘ï¼Œæ‹è§†é¢‘çš„æ—¶å€™æ€»æ˜¯å¿˜è¯æ€ä¹ˆåŠï¼Ÿ

å…¶å®å¾ˆç®€å•ï¼Œç”¨æè¯å™¨å°±å¯ä»¥å•¦ï¼

åƒæˆ‘ç°åœ¨å°±æ˜¯ä¸€è¾¹çœ‹ç€æè¯å™¨ï¼Œä¸€è¾¹å½•è§†é¢‘ã€‚

è¿™æ ·å°±ä¸ç”¨æ‹…å¿ƒå¿˜è¯äº†ï¼Œè€Œä¸”è¯­é€Ÿä¹Ÿå¯ä»¥æ§åˆ¶å¾—å¾ˆç¨³å®šã€‚

å¥½å•¦ï¼Œä»Šå¤©çš„åˆ†äº«å°±åˆ°è¿™é‡Œã€‚

å¦‚æœè§‰å¾—æœ‰ç”¨çš„è¯ï¼Œè®°å¾—ç‚¹èµæ”¶è—å“¦ï¼

æˆ‘ä»¬ä¸‹æœŸå†è§ï¼Œæ‹œæ‹œï½ ğŸ‘‹</textarea>
            <button id="clearBtn" style="position: absolute; top: 10px; right: 10px; background: rgba(255,107,157,0.8); border: none; color: #fff; padding: 8px 12px; border-radius: 8px; font-size: 14px; cursor: pointer;">ğŸ—‘ï¸ æ¸…ç©º</button>
        </div>
        
        <div class="control-group">
            <label>ğŸ“ å­—ä½“å¤§å°</label>
            <input type="range" id="fontSize" min="24" max="72" value="42">
            <div class="value-display" id="fontSizeValue">42px</div>
        </div>
        
        <div class="control-group">
            <label>ğŸ¤ æ»šåŠ¨æ¨¡å¼</label>
            <div class="toggle-group">
                <button class="toggle-btn active" data-scroll-mode="auto">è‡ªåŠ¨æ»šåŠ¨</button>
                <button class="toggle-btn" data-scroll-mode="voice" id="voiceModeBtn">è¯­éŸ³è·Ÿè¸ª</button>
            </div>
            <div class="feature-note" id="voiceNote">è¯­éŸ³è·Ÿè¸ªï¼šæ ¹æ®ä½ è¯´çš„è¯è‡ªåŠ¨æ»šåŠ¨ï¼ˆéœ€è¦éº¦å…‹é£æƒé™ï¼‰</div>
        </div>
        
        <div class="control-group" id="speedControl">
            <label>ğŸš€ æ»šåŠ¨é€Ÿåº¦</label>
            <input type="range" id="scrollSpeed" min="10" max="100" value="40">
            <div class="value-display" id="speedValue">40</div>
        </div>
        
        <div class="control-group">
            <label>â±ï¸ å¼€å§‹å€’è®¡æ—¶</label>
            <div class="toggle-group">
                <button class="toggle-btn" data-countdown="0">æ— </button>
                <button class="toggle-btn active" data-countdown="3">3ç§’</button>
                <button class="toggle-btn" data-countdown="5">5ç§’</button>
            </div>
        </div>
        
        <div class="control-group">
            <label>ğŸª é•œåƒæ¨¡å¼ï¼ˆé…åˆé•œå­ä½¿ç”¨ï¼‰</label>
            <div class="toggle-group">
                <button class="toggle-btn active" data-mirror="false">æ­£å¸¸</button>
                <button class="toggle-btn" data-mirror="true">é•œåƒ</button>
            </div>
        </div>
        
        <button class="start-btn" id="startBtn">â–¶ï¸ å¼€å§‹æè¯</button>
    </div>
    
    <!-- æè¯å™¨ç•Œé¢ -->
    <div class="teleprompter" id="teleprompter">
        <div class="fade-top"></div>
        <div class="center-line"></div>
        
        <!-- è¯­éŸ³çŠ¶æ€æŒ‡ç¤º -->
        <div class="voice-indicator" id="voiceIndicator">
            <span class="mic-icon">ğŸ¤</span>
            <span class="heard-text" id="heardText">å¬åˆ°: ...</span>
        </div>
        
        <div class="prompter-text">
            <div class="text-content" id="textContent"></div>
        </div>
        <div class="fade-bottom"></div>
        
        <div class="control-bar">
            <button class="ctrl-btn" id="backBtn">â¬…ï¸</button>
            <div class="speed-adjust" id="speedAdjustBar">
                <button id="speedDown">âˆ’</button>
                <span id="currentSpeed">40</span>
                <button id="speedUp">+</button>
            </div>
            <button class="ctrl-btn play" id="playPauseBtn">â¸ï¸</button>
            <button class="ctrl-btn" id="voiceBtn" style="display:none;">ğŸ¤</button>
            <button class="ctrl-btn" id="resetBtn">â†º</button>
            <button class="ctrl-btn" id="exitBtn">âœ•</button>
        </div>
    </div>
    
    <!-- å€’è®¡æ—¶ -->
    <div class="countdown" id="countdown"></div>
    
    <script>
        // çŠ¶æ€
        let isPlaying = false;
        let scrollPosition = 0;
        let speed = 40;
        let fontSize = 42;
        let countdownSeconds = 3;
        let isMirrored = false;
        let animationId = null;
        let scrollMode = 'auto'; // 'auto' or 'voice'
        
        // è¯­éŸ³è¯†åˆ«ç›¸å…³
        let recognition = null;
        let isVoiceActive = false;
        let scriptLines = [];
        let currentLineIndex = 0;
        let allText = '';
        
        // æ£€æŸ¥è¯­éŸ³è¯†åˆ«æ”¯æŒ
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const speechSupported = !!SpeechRecognition;
        
        // å…ƒç´ 
        const settingsPanel = document.getElementById('settingsPanel');
        const teleprompter = document.getElementById('teleprompter');
        const textContent = document.getElementById('textContent');
        const countdown = document.getElementById('countdown');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const currentSpeedEl = document.getElementById('currentSpeed');
        const voiceIndicator = document.getElementById('voiceIndicator');
        const heardText = document.getElementById('heardText');
        const voiceBtn = document.getElementById('voiceBtn');
        const speedAdjustBar = document.getElementById('speedAdjustBar');
        const speedControl = document.getElementById('speedControl');
        const voiceModeBtn = document.getElementById('voiceModeBtn');
        const voiceNote = document.getElementById('voiceNote');
        
        // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«
        if (speechSupported) {
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;  // è·å–ä¸­é—´ç»“æœï¼Œæ›´å¿«å“åº”
            recognition.maxAlternatives = 1;
            recognition.lang = 'zh-CN';
            
            recognition.onresult = (event) => {
                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    transcript += event.results[i][0].transcript;
                }
                
                // æ˜¾ç¤ºè¯†åˆ«åˆ°çš„æ–‡å­—
                heardText.textContent = 'å¬åˆ°: ' + transcript.slice(-30);
                console.log('è¯†åˆ«åˆ°:', transcript);
                
                // æ¨¡ç³ŠåŒ¹é…æ‰¾åˆ°å½“å‰ä½ç½®
                findAndScrollToPosition(transcript);
            };
            
            recognition.onstart = () => {
                console.log('è¯­éŸ³è¯†åˆ«å·²å¯åŠ¨');
                heardText.textContent = 'æ­£åœ¨å¬...';
            };
            
            recognition.onerror = (event) => {
                console.log('è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error);
                if (event.error === 'not-allowed') {
                    alert('è¯·å…è®¸éº¦å…‹é£æƒé™ä»¥ä½¿ç”¨è¯­éŸ³è·Ÿè¸ªåŠŸèƒ½');
                    stopVoiceRecognition();
                }
            };
            
            recognition.onend = () => {
                // å¦‚æœè¿˜åœ¨è¯­éŸ³æ¨¡å¼ï¼Œè‡ªåŠ¨é‡å¯
                if (isVoiceActive && scrollMode === 'voice') {
                    try {
                        recognition.start();
                    } catch(e) {}
                }
            };
        } else {
            // ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«
            voiceModeBtn.disabled = true;
            voiceNote.textContent = 'âš ï¸ ä½ çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œè¯·ä½¿ç”¨ Chrome æˆ– Safari';
            voiceNote.style.color = '#ff6b6b';
        }
        
        // æ¨¡ç³ŠåŒ¹é…å‡½æ•° - å¹³è¡¡ç‰ˆæœ¬
        function findAndScrollToPosition(transcript) {
            // æ¸…ç†æ–‡æœ¬
            const cleanTranscript = transcript.replace(/[ï¼Œã€‚ï¼ï¼Ÿã€,.\s\nÂ·~ï¼@#ï¿¥%â€¦â€¦&*ï¼ˆï¼‰â€”+=\[\]{}|;:'",.<>/?]/g, '');
            if (cleanTranscript.length < 4) return;
            
            // å–æœ€åè¯†åˆ«çš„5-12ä¸ªå­—
            const recentText = cleanTranscript.slice(-12);
            
            // æ£€æŸ¥æ¥ä¸‹æ¥çš„3è¡Œ
            for (let offset = 1; offset <= 3; offset++) {
                const checkLine = currentLineIndex + offset;
                if (checkLine >= scriptLines.length) break;
                
                const lineClean = scriptLines[checkLine].replace(/[ï¼Œã€‚ï¼ï¼Ÿã€,.\s\nÂ·~ï¼@#ï¿¥%â€¦â€¦&*ï¼ˆï¼‰â€”+=\[\]{}|;:'",.<>/?]/g, '');
                
                // éœ€è¦åŒ¹é…4ä¸ªå­—ä»¥ä¸Šæ‰æ»šåŠ¨
                for (let len = 4; len <= Math.min(recentText.length, 8); len++) {
                    const searchStr = recentText.slice(-len);
                    if (lineClean.includes(searchStr)) {
                        console.log(`åŒ¹é…! ç¬¬${checkLine}è¡Œ "${searchStr}"`);
                        scrollToLine(checkLine);
                        return;
                    }
                }
            }
        }
        
        // æ»šåŠ¨åˆ°æŒ‡å®šè¡Œ
        function scrollToLine(lineIndex) {
            if (lineIndex < currentLineIndex) return; // åªå¾€å‰ï¼Œä¸å¾€å›
            if (lineIndex === currentLineIndex) return; // å·²ç»åœ¨è¿™è¡Œ
            
            currentLineIndex = lineIndex;
            
            // æ›´æ–°é«˜äº®
            const paragraphs = textContent.querySelectorAll('p');
            paragraphs.forEach((p, i) => {
                p.classList.remove('current', 'spoken');
                if (i < lineIndex) {
                    p.classList.add('spoken');
                } else if (i === lineIndex) {
                    p.classList.add('current');
                }
            });
            
            // æ»šåŠ¨åˆ°è¯¥è¡Œ
            const targetP = paragraphs[lineIndex];
            if (targetP) {
                const targetY = window.innerHeight / 2 - targetP.offsetTop - targetP.offsetHeight / 2;
                scrollPosition = targetY;
                updateTransform();
            }
        }
        
        function updateTransform() {
            const transform = isMirrored 
                ? `translateY(${scrollPosition}px) scaleX(-1)` 
                : `translateY(${scrollPosition}px)`;
            textContent.style.transform = transform;
        }
        
        function startVoiceRecognition() {
            if (!recognition) return;
            isVoiceActive = true;
            voiceIndicator.classList.add('active');
            voiceBtn.classList.add('voice-active');
            playPauseBtn.style.display = 'none';
            voiceBtn.style.display = 'flex';
            speedAdjustBar.style.display = 'none';
            
            try {
                recognition.start();
            } catch(e) {
                console.log('å·²åœ¨è¯†åˆ«ä¸­');
            }
        }
        
        function stopVoiceRecognition() {
            if (!recognition) return;
            isVoiceActive = false;
            voiceIndicator.classList.remove('active');
            voiceBtn.classList.remove('voice-active');
            
            try {
                recognition.stop();
            } catch(e) {}
        }
        
        // æ¸…ç©ºæŒ‰é’®
        document.getElementById('clearBtn').addEventListener('click', () => {
            document.getElementById('scriptText').value = '';
            document.getElementById('scriptText').focus();
        });
        
        // è®¾ç½®äº‹ä»¶
        document.getElementById('fontSize').addEventListener('input', (e) => {
            fontSize = e.target.value;
            document.getElementById('fontSizeValue').textContent = fontSize + 'px';
        });
        
        document.getElementById('scrollSpeed').addEventListener('input', (e) => {
            speed = parseInt(e.target.value);
            document.getElementById('speedValue').textContent = speed;
            currentSpeedEl.textContent = speed;
        });
        
        // æ»šåŠ¨æ¨¡å¼é€‰æ‹©
        document.querySelectorAll('[data-scroll-mode]').forEach(btn => {
            btn.addEventListener('click', () => {
                if (btn.disabled) return;
                document.querySelectorAll('[data-scroll-mode]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                scrollMode = btn.dataset.scrollMode;
                
                // è¯­éŸ³æ¨¡å¼ä¸‹éšè—é€Ÿåº¦æ§åˆ¶
                speedControl.style.display = scrollMode === 'voice' ? 'none' : 'block';
            });
        });
        
        // å€’è®¡æ—¶é€‰æ‹©
        document.querySelectorAll('[data-countdown]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('[data-countdown]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                countdownSeconds = parseInt(btn.dataset.countdown);
            });
        });
        
        // é•œåƒé€‰æ‹©
        document.querySelectorAll('[data-mirror]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('[data-mirror]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                isMirrored = btn.dataset.mirror === 'true';
            });
        });
        
        // å¼€å§‹
        document.getElementById('startBtn').addEventListener('click', () => {
            const text = document.getElementById('scriptText').value.trim();
            if (!text) {
                alert('è¯·å…ˆè¾“å…¥æ–‡æ¡ˆï¼');
                return;
            }
            
            // ä¿å­˜è„šæœ¬è¡Œ
            scriptLines = text.split('\n').filter(line => line.trim());
            allText = text;
            currentLineIndex = 0;
            
            // è®©è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹ï¼Œç¡®ä¿ä»å¤´å¼€å§‹
            document.getElementById('scriptText').blur();
            
            // è®¾ç½®æ–‡æœ¬
            textContent.innerHTML = text.split('\n').map((line, i) => 
                line ? `<p style="margin: 0.5em 0;" data-line="${i}">${line}</p>` : '<p style="margin: 0.5em 0;">&nbsp;</p>'
            ).join('');
            textContent.style.fontSize = fontSize + 'px';
            
            if (isMirrored) {
                textContent.classList.add('mirrored');
            } else {
                textContent.classList.remove('mirrored');
            }
            
            // é‡ç½®ä½ç½® - ç¡®ä¿ä»ç¬¬ä¸€è¡Œå¼€å§‹
            scrollPosition = window.innerHeight / 2;
            updateTransform();
            
            // é«˜äº®ç¬¬ä¸€è¡Œ
            setTimeout(() => {
                const firstP = textContent.querySelector('p');
                if (firstP) firstP.classList.add('current');
            }, 100);
            
            // è®¾ç½®æ§åˆ¶æ 
            if (scrollMode === 'voice') {
                playPauseBtn.style.display = 'none';
                voiceBtn.style.display = 'flex';
                speedAdjustBar.style.display = 'none';
            } else {
                playPauseBtn.style.display = 'flex';
                voiceBtn.style.display = 'none';
                speedAdjustBar.style.display = 'flex';
            }
            
            settingsPanel.classList.add('hidden');
            teleprompter.classList.add('active');
            
            // å€’è®¡æ—¶
            if (countdownSeconds > 0) {
                startCountdown();
            } else {
                if (scrollMode === 'voice') {
                    startVoiceRecognition();
                } else {
                    startScrolling();
                }
            }
        });
        
        function startCountdown() {
            let count = countdownSeconds;
            countdown.classList.add('active');
            countdown.textContent = count;
            
            const timer = setInterval(() => {
                count--;
                if (count > 0) {
                    countdown.textContent = count;
                } else {
                    clearInterval(timer);
                    countdown.classList.remove('active');
                    if (scrollMode === 'voice') {
                        startVoiceRecognition();
                    } else {
                        startScrolling();
                    }
                }
            }, 1000);
        }
        
        function startScrolling() {
            isPlaying = true;
            playPauseBtn.textContent = 'â¸ï¸';
            scroll();
        }
        
        function scroll() {
            if (!isPlaying) return;
            
            scrollPosition -= speed / 60;
            updateTransform();
            
            // æ£€æŸ¥æ˜¯å¦æ»šåŠ¨å®Œæ¯•
            const textHeight = textContent.offsetHeight;
            if (scrollPosition < -textHeight) {
                isPlaying = false;
                playPauseBtn.textContent = 'â–¶ï¸';
                return;
            }
            
            animationId = requestAnimationFrame(scroll);
        }
        
        // æ’­æ”¾/æš‚åœ
        playPauseBtn.addEventListener('click', () => {
            if (isPlaying) {
                isPlaying = false;
                playPauseBtn.textContent = 'â–¶ï¸';
                cancelAnimationFrame(animationId);
            } else {
                startScrolling();
            }
        });
        
        // è¯­éŸ³æŒ‰é’®åˆ‡æ¢
        voiceBtn.addEventListener('click', () => {
            if (isVoiceActive) {
                stopVoiceRecognition();
            } else {
                startVoiceRecognition();
            }
        });
        
        // é€Ÿåº¦è°ƒèŠ‚
        document.getElementById('speedUp').addEventListener('click', () => {
            speed = Math.min(100, speed + 5);
            currentSpeedEl.textContent = speed;
        });
        
        document.getElementById('speedDown').addEventListener('click', () => {
            speed = Math.max(10, speed - 5);
            currentSpeedEl.textContent = speed;
        });
        
        // é‡ç½®
        document.getElementById('resetBtn').addEventListener('click', () => {
            isPlaying = false;
            cancelAnimationFrame(animationId);
            currentLineIndex = 0;
            scrollPosition = window.innerHeight / 2;
            updateTransform();
            playPauseBtn.textContent = 'â–¶ï¸';
            
            // æ¸…é™¤é«˜äº®
            textContent.querySelectorAll('p').forEach(p => {
                p.classList.remove('current', 'spoken');
            });
        });
        
        // è¿”å›è®¾ç½®
        document.getElementById('backBtn').addEventListener('click', () => {
            exitPrompter();
        });
        
        document.getElementById('exitBtn').addEventListener('click', () => {
            exitPrompter();
        });
        
        function exitPrompter() {
            isPlaying = false;
            cancelAnimationFrame(animationId);
            stopVoiceRecognition();
            teleprompter.classList.remove('active');
            settingsPanel.classList.remove('hidden');
        }
        
        // è§¦æ‘¸æ§åˆ¶ï¼ˆç‚¹å‡»å±å¹•æš‚åœ/ç»§ç»­ï¼‰- ä»…è‡ªåŠ¨æ¨¡å¼
        document.querySelector('.prompter-text').addEventListener('click', () => {
            if (scrollMode === 'auto') {
                if (isPlaying) {
                    isPlaying = false;
                    playPauseBtn.textContent = 'â–¶ï¸';
                    cancelAnimationFrame(animationId);
                } else {
                    startScrolling();
                }
            }
        });
        
        // é˜²æ­¢iOSæ©¡çš®ç­‹æ•ˆæœ
        document.body.addEventListener('touchmove', (e) => {
            if (teleprompter.classList.contains('active')) {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
</html>
